<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>업로드 창</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
        }

        h2 {
            margin-left: 10%;
        }

        table {
            margin-left: 10%;
            table-layout: auto;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            white-space: nowrap;
        }

        input,
        select {
            width: 95%;
            padding: 4px;
        }

        input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }

        button {
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
            width: 100px;
        }

        .floating-buttons {
            position: fixed;
            left: 50px;
            top: 70%;
            transform: translateY(-50%);

            display: flex;
            flex-direction: column;
            gap: 10px;

            background: white;
            z-index: 999;
        }
    </style>
</head>

<body>

    <table id="form_table">
        <thead>
            <tr>
                <th>#</th>
                <th>이름</th>
                <th>현금</th>
                <th>카드</th>
                <th>통장입금</th>
                <th>현금영수증</th>
                <th>기타</th>
                <th>합계</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td>1</td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="checkbox" class="receipt"></td>
                <td><input type="text"></td>
                <td class="sum_row">0</td>
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <td>합계</td>
                <td>-</td>
                <td id="sum1">0</td>
                <td id="sum2">0</td>
                <td id="sum3">0</td>
                <td>-</td>
                <td>-</td>
                <td id="sum4">0</td>
            </tr>
        </tfoot>
    </table>

    <div class="floating-buttons">
        <h2 id="title">작성 폼</h2>
        <button onclick="addRow()">행 추가</button>
        <button onclick="submitAll()">전체 제출</button>
    </div>

    <script>
        // 폼 ID
        const FORMID = "";
        // entry 번호
        const ENTRY = {
            name: "entry.",
            bill: "entry.",
            card: "entry.",
            cache: "entry.",
            receipt: "entry.",
            etc: "entry."
        };
        const FORM_URL =
            "https://docs.google.com/forms/d/e/" + FORMID + "/formResponse";

        // 행 추가
        function addRow() {
            const tbody = document.querySelector("#form_table tbody");
            const newRow = tbody.rows[0].cloneNode(true);

            const rowNumber = tbody.rows.length + 1;
            newRow.cells[0].innerText = rowNumber;

            newRow.querySelectorAll("input").forEach((i, idx) => {
                if (i.type === "checkbox") i.checked = false;
                else i.value = "";
            });

            tbody.appendChild(newRow);
        }

        // h2 update
        function updateh2(text) {
            const h2 = document.getElementById("title");
            h2.innerHTML = "업로드 중: " + text;
        }

        // row 제출
        async function submitRow(name, bill, card, cache, receipt, etc) {
            const data = new FormData();

            data.append(ENTRY.name, name);
            data.append(ENTRY.bill, bill);
            data.append(ENTRY.card, card);
            data.append(ENTRY.cache, cache);
            data.append(ENTRY.receipt, receipt);
            data.append(ENTRY.etc, etc);

            await fetch(FORM_URL, {
                method: "POST",
                mode: "no-cors",
                body: data
            });
        }

        // 전체 제출
        async function submitAll() {

            if (!confirm("현재 작성된 페이지를 제출합니다.")) return;
            const rows = document.querySelectorAll("#form_table tbody tr");

            for (let i = 0; i < rows.length; i++) {
                let a = i + 1;
                updateh2(a + "/" + rows.length);
                const row = rows[i];
                const inputs = row.querySelectorAll("input, select");

                const name = inputs[0].value.trim();
                const bill = inputs[1].value.trim();
                const card = inputs[2].value.trim();
                const cache = inputs[3].value.trim();
                const receipt = inputs[4].checked ? "Y" : "N";
                const etc = inputs[5].value.trim();

                if (!name) continue;

                await submitRow(name, bill, card, cache, receipt, etc);
            }

            alert("제출 완료");
            location.reload();
        }

        // 합산값 계산
        function updateSums() {
            const tbody = document.querySelector("#form_table tbody");
            let sum1 = 0, sum2 = 0, sum3 = 0;

            tbody.querySelectorAll("tr").forEach(row => {
                const cells = row.querySelectorAll("input");
                const sum_row = row.querySelector(".sum_row");
                let num1 = Number(cells[1].value) || 0;
                let num2 = Number(cells[2].value) || 0;
                let num3 = Number(cells[3].value) || 0;
                sum1 += num1;
                sum2 += num2;
                sum3 += num3;
                sum_row.innerHTML = num1 + num2 + num3;
            });

            document.getElementById("sum1").innerText = sum1;
            document.getElementById("sum2").innerText = sum2;
            document.getElementById("sum3").innerText = sum3;
            document.getElementById("sum4").innerText = sum1 + sum2 + sum3;
        }

        // input 변경시 updateSums
        document.querySelector("#form_table tbody").addEventListener("input", function (e) {
            if (e.target.tagName === "INPUT") {
                updateSums();
            }
        });

        //init 시 40개 생성
        document.addEventListener("DOMContentLoaded", function (e) {
            for (let i = 1; i < 40; i++) {
                addRow();
            }
        });
    </script>

</body>

</html>